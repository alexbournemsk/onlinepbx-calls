<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .navigation {
            margin-bottom: 20px;
        }
        .navigation a {
            display: inline-block;
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .navigation a:hover {
            background-color: #0056b3;
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-top: 20px;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background-color: #007bff; 
            color: white; 
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .date-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .date-link:hover {
            text-decoration: underline;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
        }
        .filter-btn {
            padding: 8px 16px;
            margin-right: 10px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .filter-btn:hover {
            background-color: #007bff;
            color: white;
        }
        .filter-btn.active {
            background-color: #007bff;
            color: white;
        }
        .hidden-row {
            display: none;
        }
        .mode-btn {
            padding: 10px 24px;
            margin-right: 10px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .mode-btn:hover {
            background-color: #e7f3ff;
        }
        .mode-btn.active {
            background-color: #007bff;
            color: white;
        }
        .week-header {
            background-color: #007bff !important;
            color: white !important;
            text-align: center;
            font-weight: bold;
            white-space: nowrap;
        }
        .metric-label {
            font-size: 13px;
            color: #666;
            font-weight: normal;
        }
        .number-row-group {
            border-bottom: 3px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</h1>
        
        <div class="navigation">
            <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/trunks">–ù–æ–º–µ—Ä–∞</a>
            <a href="/stats" class="active">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        </div>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ -->
        <div style="margin-bottom: 20px;">
            <button onclick="switchMode('daily')" class="mode-btn {% if mode == 'daily' %}active{% endif %}" id="mode-daily">–ü–æ –¥–Ω—è–º</button>
            <button onclick="switchMode('weekly')" class="mode-btn {% if mode == 'weekly' %}active{% endif %}" id="mode-weekly">–ü–æ –Ω–µ–¥–µ–ª—è–º</button>
        </div>
        
        <div class="info-box">
            <strong>üìä –ê—Ä—Ö–∏–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</strong><br>
            {% if mode == 'weekly' %}
            –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º —Å —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∑–∞ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é.
            {% else %}
            –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–º –¥–Ω—è–º. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
            {% endif %}
        </div>
        
        {% if comprehensive_stats %}
        <h2>–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–æ–º–µ—Ä–∞–º</h2>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
        <div style="margin-bottom: 15px;">
            <button onclick="filterTable('all')" class="filter-btn active" id="filter-all">–í—Å–µ</button>
            <button onclick="filterTable('kc')" class="filter-btn" id="filter-kc">–ö–¶</button>
            <button onclick="filterTable('op')" class="filter-btn" id="filter-op">–û–ü</button>
        </div>
        
        <div style="overflow-x: auto; margin-bottom: 30px;">
            {% if mode == 'weekly' and weekly_periods %}
            <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
            <table style="min-width: 800px;" id="stats-table">
                <thead>
                    <tr>
                        <th rowspan="2" style="vertical-align: middle;">–ù–æ–º–µ—Ä</th>
                        <th rowspan="2" style="vertical-align: middle; min-width: 140px;"></th>
                        {% for week in weekly_periods %}
                        <th class="week-header">
                            <div>{{ week.label }}</div>
                            {% if week.description %}
                            <div style="font-size: 11px; font-weight: normal; margin-top: 3px;">{{ week.description }}</div>
                            {% endif %}
                        </th>
                        {% endfor %}
                    </tr>
                    <tr>
                        {% for week in weekly_periods %}
                        <th style="text-align: center; font-size: 12px; background-color: #f8f9fa; color: #333;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for number_stat in comprehensive_stats %}
                    <!-- –°—Ç—Ä–æ–∫–∞ 1: –≤—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤ -->
                    <tr class="number-data-row" data-description="{{ number_stat.description|lower }}">
                        <td rowspan="3" style="vertical-align: top; text-align: left; border-bottom: 3px solid #333;">
                            <strong>{{ number_stat.caller_number }}</strong><br>
                            <small style="color: #666;">{{ number_stat.description if number_stat.description else '-' }}</small>
                        </td>
                        <td style="text-align: left; padding-left: 15px;"><span class="metric-label">–≤—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</span></td>
                        {% for week in weekly_periods %}
                            {% set week_data = number_stat.weeks[week.key] %}
                            {% if week_data and week_data.total_calls > 0 %}
                                <td style="text-align: center;"><strong>{{ week_data.total_calls }}</strong></td>
                            {% else %}
                                <td style="text-align: center;">-</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    <!-- –°—Ç—Ä–æ–∫–∞ 2: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤ >45—Å -->
                    <tr class="number-data-row" data-description="{{ number_stat.description|lower }}">
                        <td style="text-align: left; padding-left: 15px;"><span class="metric-label">–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤ >45—Å</span></td>
                        {% for week in weekly_periods %}
                            {% set week_data = number_stat.weeks[week.key] %}
                            {% if week_data and week_data.total_calls > 0 %}
                                <td style="text-align: center;">{{ week_data.calls_over_45s }}</td>
                            {% else %}
                                <td style="text-align: center;">-</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    <!-- –°—Ç—Ä–æ–∫–∞ 3: % >45—Å -->
                    <tr class="number-data-row" data-description="{{ number_stat.description|lower }}">
                        <td style="text-align: left; padding-left: 15px; border-bottom: 3px solid #333;"><span class="metric-label">% >45—Å</span></td>
                        {% for week in weekly_periods %}
                            {% set week_data = number_stat.weeks[week.key] %}
                            {% if week_data and week_data.total_calls > 0 %}
                                <td style="text-align: center; border-bottom: 3px solid #333; color: {% if week_data.percentage_over_45s >= 20 %}#28a745{% elif week_data.percentage_over_45s >= 10 %}#ffc107{% else %}#dc3545{% endif %}; font-weight: bold;">
                                    {{ "%.1f"|format(week_data.percentage_over_45s) }}%
                                </td>
                            {% else %}
                                <td style="text-align: center; border-bottom: 3px solid #333;">-</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% elif mode == 'daily' and formatted_dates %}
            <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –¥–Ω–µ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
            <table style="min-width: 600px;" id="stats-table">
                <thead>
                    <tr>
                        <th rowspan="3">–ù–æ–º–µ—Ä</th>
                        <th rowspan="3" style="vertical-align: middle; min-width: 140px;"></th>
                        {% for date in formatted_dates %}
                        <th style="text-align: center;">{{ date.display }}</th>
                        {% endfor %}
                    </tr>
                    <tr>
                        {% for date in formatted_dates %}
                        <th style="text-align: center; font-size: 12px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for number_stat in comprehensive_stats %}
                    <!-- –°—Ç—Ä–æ–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–≤–æ–Ω–∫–æ–≤ -->
                    <tr class="number-data-row" data-description="{{ number_stat.description|lower }}">
                        <td rowspan="3" style="vertical-align: top; text-align: left; border-bottom: 3px solid #333;">
                            <strong>{{ number_stat.caller_number }}</strong><br>
                            <small style="color: #666;">{{ number_stat.description if number_stat.description else '-' }}</small>
                        </td>
                        <td style="text-align: left; padding-left: 15px;"><span class="metric-label">–≤—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</span></td>
                        {% for date in formatted_dates %}
                            {% if number_stat.dates[date.date] %}
                                <td style="text-align: center;"><strong>{{ number_stat.dates[date.date].total_calls }}</strong></td>
                            {% else %}
                                <td style="text-align: center;">-</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    <!-- –°—Ç—Ä–æ–∫–∞ —Å–æ –∑–≤–æ–Ω–∫–∞–º–∏ >45—Å -->
                    <tr class="number-data-row" data-description="{{ number_stat.description|lower }}">
                        <td style="text-align: left; padding-left: 15px;"><span class="metric-label">–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤ >45—Å</span></td>
                        {% for date in formatted_dates %}
                            {% if number_stat.dates[date.date] %}
                                <td style="text-align: center;">{{ number_stat.dates[date.date].calls_over_45s }}</td>
                            {% else %}
                                <td style="text-align: center;">-</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    <!-- –°—Ç—Ä–æ–∫–∞ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ -->
                    <tr class="number-data-row" data-description="{{ number_stat.description|lower }}">
                        <td style="text-align: left; padding-left: 15px; border-bottom: 3px solid #333;"><span class="metric-label">% >45—Å</span></td>
                        {% for date in formatted_dates %}
                            {% if number_stat.dates[date.date] %}
                                {% set day_data = number_stat.dates[date.date] %}
                                <td style="text-align: center; border-bottom: 3px solid #333; color: {% if day_data.percentage_over_45s >= 20 %}#28a745{% elif day_data.percentage_over_45s >= 15 %}#90EE90{% elif day_data.percentage_over_45s >= 10 %}#ffc107{% else %}#dc3545{% endif %}; font-weight: bold;">
                                    {{ "%.1f"|format(day_data.percentage_over_45s) }}%
                                </td>
                            {% else %}
                                <td style="text-align: center; border-bottom: 3px solid #333;">-</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endif %}
        
        <h2>–°–ø–∏—Å–æ–∫ –¥–Ω–µ–π —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π</h2>
        {% if stats_dates %}
        <table>
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ü–µ—Ä–∏–æ–¥</th>
                    <th>–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in stats_dates %}
                <tr>
                    <td><a href="/stats/{{ stat.date }}" class="date-link">{{ stat.date_display }}</a></td>
                    <td>{{ stat.period_label }}</td>
                    <td><strong>{{ stat.total_calls }}</strong></td>
                    <td><a href="/stats/{{ stat.date }}" class="date-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-data">
            <p>üì≠ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞</p>
            <p>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã "–ó–∞ —Å–µ–≥–æ–¥–Ω—è", "–ó–∞ –≤—á–µ—Ä–∞" –∏–ª–∏ "–ó–∞ –ø–æ–∑–∞–≤—á–µ—Ä–∞" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
        </div>
        {% endif %}
    </div>

    <script>
        function switchMode(mode) {
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º mode
            window.location.href = '/stats?mode=' + mode;
        }
        
        function filterTable(filterType) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
            document.getElementById('filter-' + filterType).classList.add('active');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å –∫–ª–∞—Å—Å–æ–º number-data-row
            const table = document.querySelector('#stats-table tbody');
            if (!table) return;
            
            const rows = table.querySelectorAll('tr.number-data-row');
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º –∏–∑ 3 —Å—Ç—Ä–æ–∫ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–º–µ—Ä–∞)
            for (let i = 0; i < rows.length; i += 3) {
                const firstRow = rows[i];
                if (!firstRow) continue;
                
                // –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
                const description = firstRow.getAttribute('data-description') || '';
                
                let shouldShow = false;
                
                if (filterType === 'all') {
                    shouldShow = true;
                } else if (filterType === 'kc') {
                    shouldShow = description.includes('–∫—Ü');
                } else if (filterType === 'op') {
                    shouldShow = description.includes('–æ–ø');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ 3 —Å—Ç—Ä–æ–∫–∏ –≥—Ä—É–ø–ø—ã
                for (let j = 0; j < 3; j++) {
                    const row = rows[i + j];
                    if (row) {
                        if (shouldShow) {
                            row.classList.remove('hidden-row');
                        } else {
                            row.classList.add('hidden-row');
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>

